{% extends "base.html" %}
{% block title %}CodeEditor{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-16 px-4 sm:px-6 space-y-6">

  <!-- Project Title -->
  <div class="bg-white shadow-md rounded-lg p-6">
    <h1 class="text-2xl md:text-3xl font-bold text-center text-blue-700 mb-4">
      {{ project.title }}
    </h1>
    <p class="text-gray-700 text-center mb-6">{{ project.description }}</p>

    <!-- Language Dropdown -->
    <div class="mb-4">
      <label for="lang" class="block font-semibold mb-2">Choose Language:</label>
      <select id="lang" 
              class="border border-gray-300 focus:ring focus:ring-blue-200 rounded-lg w-full md:w-1/3 p-2">
        <option value="python">Python</option>
        <option value="java">Java</option>
        <option value="cpp">C++</option>
        <option value="javascript">JavaScript</option>
        <option value="html">HTML</option>
        <option value="css">CSS</option>
        <option value="sql">SQL</option>
      </select>
    </div>

    <!-- Monaco Editor -->
    <div id="editor" class="h-96 border rounded-lg shadow mb-6"></div>

    <!-- Submit Button -->
    <div class="flex justify-center">
      <button id="submitBtn" 
              class="bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-2 rounded-lg shadow transition">
         Submit Code
      </button>
    </div>

    <!-- Response Message -->
    <p id="response" class="mt-4 text-center text-sm font-semibold"></p>
  </div>
</div>

<!-- Monaco Editor CDN -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs/loader.js"></script>
<script>
require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs' }});
require(["vs/editor/editor.main"], function () {
    window.editor = monaco.editor.create(document.getElementById("editor"), {
        value: "// Write your code here...",
        language: "python",
        theme: "vs-dark",
        automaticLayout: true
    });
});

function changeLanguage() {
    const lang = document.getElementById("lang").value;
    monaco.editor.setModelLanguage(editor.getModel(), lang);
}

document.getElementById("lang").addEventListener("change", changeLanguage);

document.getElementById("submitBtn").addEventListener("click", function() {
    const lang = document.getElementById("lang").value;
    const code = editor.getValue();

    fetch("{% url 'submit_code' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: new URLSearchParams({
            "project_id": "{{ project.id }}",
            "language": lang,
            "code": code
        })
    })
    .then(res => res.json())
    .then(data => {
        const resp = document.getElementById("response");
        if (data.success) {
            resp.className = "mt-4 text-center text-green-600 font-semibold";
            resp.innerText = "✅ Code submitted successfully! Redirecting...";
            setTimeout(() => {
                window.location.href = "{% url 'my_submissions' %}";
            }, 1500);
        } else {
            resp.className = "mt-4 text-center text-red-600 font-semibold";
            resp.innerText = data.message;
        }
    })
    .catch(err => {
        document.getElementById("response").className = "mt-4 text-center text-red-600 font-semibold";
        document.getElementById("response").innerText = "❌ Error submitting code.";
        console.error(err);
    });
});
</script>
{% endblock %}
